<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Licet</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 60px; }
        .status-up { background-color: #d4edda; }
        .status-down { background-color: #f8d7da; }
        .status-warning { background-color: #fff3cd; }

        .utilization-card {
            margin-bottom: 1rem;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .utilization-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .checkout-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }
        .card-body {
            position: relative;
        }
        .utilization-low { border-left: 4px solid #28a745; }
        .utilization-medium { border-left: 4px solid #ffc107; }
        .utilization-high { border-left: 4px solid #dc3545; }

        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 2rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .detail-link-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }

        .detail-link-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .detail-link-card h5 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .detail-link-card p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 1rem;
        }

        .detail-link-card .btn {
            background-color: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
        }

        .detail-link-card .btn:hover {
            background-color: white;
            color: #667eea;
        }

        .quick-stats {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            text-align: center;
            padding: 1rem;
        }

        .stat-box h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-box p {
            color: #6c757d;
            margin: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">Licet</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    {{if .UtilizationEnabled}}
                    <li class="nav-item active">
                        <a class="nav-link" href="/utilization">Utilization</a>
                    </li>
                    {{end}}
                    <li class="nav-item">
                        <a class="nav-link" href="/alerts">Alerts</a>
                    </li>
                    {{if .StatisticsEnabled}}
                    <li class="nav-item">
                        <a class="nav-link" href="/statistics">Statistics</a>
                    </li>
                    {{end}}
                    <li class="nav-item">
                        <a class="nav-link" href="/api/v1/health">API</a>
                    </li>
                    {{if .SettingsEnabled}}
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                    {{end}}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>License Utilization Overview</h1>
        <p>Real-time snapshot of license usage across all servers</p>

        <!-- Filters Section -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label for="serverFilter" class="form-label">Filter by Server</label>
                    <select id="serverFilter" class="form-select">
                        <option value="">All Servers</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select id="sortBy" class="form-select">
                        <option value="utilization">Utilization %</option>
                        <option value="feature">Feature Name</option>
                        <option value="server">Server</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="refreshBtn" class="btn btn-primary w-100">
                        <span id="refreshIcon">ðŸ”„</span> Refresh
                    </button>
                </div>
                <div class="col-md-3">
                    <button id="exportBtn" class="btn btn-outline-primary w-100">
                        ðŸ“Š Export to CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats Summary -->
        <div class="quick-stats">
            <div class="row">
                <div class="col-md-3 stat-box">
                    <h3 id="totalFeatures">-</h3>
                    <p>Total Features</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="avgUtilization">-</h3>
                    <p>Avg Utilization</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="highUtilization">-</h3>
                    <p>High Usage (>90%)</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="totalLicenses">-</h3>
                    <p>Total Licenses</p>
                </div>
            </div>
        </div>

        <!-- Detail Page Links -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="detail-link-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5>ðŸ“ˆ Usage Trends</h5>
                    <p>View historical usage patterns and trends over time</p>
                    <a href="/utilization/trends" class="btn">View Trends â†’</a>
                </div>
            </div>
            <div class="col-md-4">
                <div class="detail-link-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h5>ðŸ”® Predictive Analytics</h5>
                    <p>Forecasting, anomaly detection, and capacity planning</p>
                    <a href="/utilization/analytics" class="btn">View Analytics â†’</a>
                </div>
            </div>
            <div class="col-md-4">
                <div class="detail-link-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h5>ðŸ“Š Detailed Statistics</h5>
                    <p>Comprehensive statistics table with averages and peaks</p>
                    <a href="/utilization/stats" class="btn">View Statistics â†’</a>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading utilization data...</p>
        </div>

        <!-- Current Utilization Section -->
        <div id="currentUtilizationSection">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Current License Utilization</h2>
                <small class="text-muted">Last updated: <span id="lastUpdated">-</span></small>
            </div>
            <div id="currentUtilization" class="row">
                <!-- Utilization cards will be inserted here -->
            </div>
        </div>

        <hr>
        <footer>
            <p class="text-muted">
                Licet {{if .Version}}v{{.Version}}{{end}} |
                <a href="https://github.com/thoscut/licet">GitHub</a>
            </p>
        </footer>
    </div>

    <!-- Checkouts Modal -->
    <div class="modal fade" id="checkoutsModal" tabindex="-1" aria-labelledby="checkoutsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkoutsModalLabel">Current Checkouts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="checkoutsLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading checkout data...</p>
                    </div>
                    <div id="checkoutsContent" style="display: none;">
                        <div class="mb-3">
                            <span class="badge bg-primary" id="modalFeatureName"></span>
                            <span class="badge bg-secondary" id="modalServerName"></span>
                        </div>
                        <div id="checkoutsTableWrapper">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>User</th>
                                        <th>Host</th>
                                        <th>Checked Out At</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="checkoutsTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="noCheckouts" class="alert alert-info" style="display: none;">
                            No active checkouts for this feature.
                        </div>
                    </div>
                    <div id="checkoutsError" class="alert alert-danger" style="display: none;">
                        Failed to load checkout data. Please try again.
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="viewDetailsLink" href="#" class="btn btn-outline-primary">View Full Details</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.min.js"></script>
    <script>
        let currentUtilizationData = [];
        let allServers = new Set();

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadServers();
            loadData();

            // Event listeners
            document.getElementById('serverFilter').addEventListener('change', loadData);
            document.getElementById('sortBy').addEventListener('change', renderUtilization);
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);

            // Auto-refresh every 5 minutes
            setInterval(loadData, 5 * 60 * 1000);
        });

        // Load available servers
        async function loadServers() {
            try {
                const response = await fetch('/api/v1/servers');
                const data = await response.json();

                const serverSelect = document.getElementById('serverFilter');
                data.servers.forEach(server => {
                    const option = document.createElement('option');
                    option.value = server.hostname;
                    option.textContent = `${server.hostname} (${server.description})`;
                    serverSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        }

        // Load current utilization data
        async function loadData() {
            showLoading(true);
            try {
                const serverFilter = document.getElementById('serverFilter').value;
                const url = `/api/v1/utilization/current${serverFilter ? '?server=' + encodeURIComponent(serverFilter) : ''}`;

                const response = await fetch(url);
                const data = await response.json();
                currentUtilizationData = data.utilization || [];

                renderUtilization();
                updateQuickStats();
                updateTimestamp();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('currentUtilization').innerHTML =
                    '<div class="col-12"><div class="alert alert-danger">Failed to load utilization data. Please try again.</div></div>';
            } finally {
                showLoading(false);
            }
        }

        // Render utilization cards (OPTIMIZED: Build HTML string first, then set once)
        function renderUtilization() {
            const container = document.getElementById('currentUtilization');

            if (currentUtilizationData.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No utilization data available. Data will appear once license servers are queried.</div></div>';
                return;
            }

            // Sort data
            const sortBy = document.getElementById('sortBy').value;
            const sortedData = [...currentUtilizationData].sort((a, b) => {
                switch(sortBy) {
                    case 'utilization':
                        return b.utilization_pct - a.utilization_pct;
                    case 'feature':
                        return a.feature_name.localeCompare(b.feature_name);
                    case 'server':
                        return a.server_hostname.localeCompare(b.server_hostname);
                    default:
                        return 0;
                }
            });

            // Build HTML string first (PERFORMANCE FIX)
            const cards = sortedData.map(item => {
                allServers.add(item.server_hostname);

                const utilizationClass = item.utilization_pct >= 90 ? 'utilization-high' :
                                       item.utilization_pct >= 70 ? 'utilization-medium' : 'utilization-low';

                const progressBarClass = item.utilization_pct >= 90 ? 'bg-danger' :
                                        item.utilization_pct >= 70 ? 'bg-warning' : 'bg-success';

                const checkoutBadge = item.used_licenses > 0
                    ? `<span class="badge bg-primary checkout-badge" title="Click to view checkouts">${item.used_licenses} checkout${item.used_licenses > 1 ? 's' : ''}</span>`
                    : '';

                return `
                    <div class="col-md-6 col-lg-4">
                        <div class="card utilization-card ${utilizationClass}"
                             onclick="showCheckouts('${escapeHtml(item.server_hostname)}', '${escapeHtml(item.feature_name)}')"
                             title="Click to view checkouts">
                            <div class="card-body">
                                ${checkoutBadge}
                                <h6 class="card-title text-truncate" title="${escapeHtml(item.feature_name)}">
                                    ${escapeHtml(item.feature_name)}
                                </h6>
                                <p class="card-text small text-muted mb-2">
                                    ${escapeHtml(item.server_hostname)}
                                    ${item.version ? `<br><span class="badge bg-info text-dark">v${item.version}</span>` : ''}
                                    ${item.vendor_daemon ? ` <span class="badge bg-secondary">${escapeHtml(item.vendor_daemon)}</span>` : ''}
                                </p>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Usage</span>
                                    <strong>${item.used_licenses} / ${item.total_licenses}</strong>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${progressBarClass}"
                                         role="progressbar"
                                         style="width: ${item.utilization_pct}%"
                                         aria-valuenow="${item.utilization_pct}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        ${item.utilization_pct.toFixed(1)}%
                                    </div>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    ${item.available_licenses} available
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Set innerHTML once (PERFORMANCE FIX)
            container.innerHTML = cards;
        }

        // Update quick stats
        function updateQuickStats() {
            const total = currentUtilizationData.length;
            const avgUtil = total > 0
                ? (currentUtilizationData.reduce((sum, item) => sum + item.utilization_pct, 0) / total).toFixed(1)
                : 0;
            const highUtil = currentUtilizationData.filter(item => item.utilization_pct >= 90).length;
            const totalLics = currentUtilizationData.reduce((sum, item) => sum + item.total_licenses, 0);

            document.getElementById('totalFeatures').textContent = total;
            document.getElementById('avgUtilization').textContent = `${avgUtil}%`;
            document.getElementById('highUtilization').textContent = highUtil;
            document.getElementById('totalLicenses').textContent = totalLics;
        }

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        // Show/hide loading indicator
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (currentUtilizationData.length === 0) {
                alert('No data to export');
                return;
            }

            const csv = [
                ['Server', 'Feature', 'Version', 'Vendor Daemon', 'Total Licenses', 'Used Licenses', 'Available', 'Utilization %'],
                ...currentUtilizationData.map(item => [
                    item.server_hostname,
                    item.feature_name,
                    item.version || '',
                    item.vendor_daemon || '',
                    item.total_licenses,
                    item.used_licenses,
                    item.available_licenses,
                    item.utilization_pct.toFixed(2)
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `license-utilization-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Server type cache
        let serverTypes = {};

        // Load server types for API calls
        async function loadServerTypes() {
            if (Object.keys(serverTypes).length > 0) return;
            try {
                const response = await fetch('/api/v1/servers');
                const data = await response.json();
                data.servers.forEach(server => {
                    serverTypes[server.hostname] = server.type || 'flexlm';
                });
            } catch (error) {
                console.error('Error loading server types:', error);
            }
        }

        // Show checkouts modal
        async function showCheckouts(serverHostname, featureName) {
            const modal = new bootstrap.Modal(document.getElementById('checkoutsModal'));

            // Reset modal state
            document.getElementById('checkoutsLoading').style.display = 'block';
            document.getElementById('checkoutsContent').style.display = 'none';
            document.getElementById('checkoutsError').style.display = 'none';

            // Update modal title and badges
            document.getElementById('checkoutsModalLabel').textContent = `Checkouts: ${featureName}`;
            document.getElementById('modalFeatureName').textContent = featureName;
            document.getElementById('modalServerName').textContent = serverHostname;
            // Don't use encodeURIComponent for the details link - @ is valid in URL paths
            // and the server expects the raw hostname
            document.getElementById('viewDetailsLink').href = `/details/${serverHostname}`;

            modal.show();

            try {
                // Ensure we have server types loaded
                await loadServerTypes();
                const serverType = serverTypes[serverHostname] || 'flexlm';

                // Fetch users/checkouts from API
                const url = `/api/v1/servers/${encodeURIComponent(serverHostname)}/users?type=${encodeURIComponent(serverType)}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const users = data.users || [];

                // Filter users by feature (case-insensitive comparison to handle
                // potential mismatches between stored feature names and live query results)
                const featureNameLower = featureName.toLowerCase();
                const checkouts = users.filter(user =>
                    user.feature_name && user.feature_name.toLowerCase() === featureNameLower
                );

                // Render checkouts
                renderCheckouts(checkouts);

            } catch (error) {
                console.error('Error loading checkouts:', error);
                document.getElementById('checkoutsLoading').style.display = 'none';
                document.getElementById('checkoutsError').style.display = 'block';
            }
        }

        // Render checkouts in the modal table
        function renderCheckouts(checkouts) {
            document.getElementById('checkoutsLoading').style.display = 'none';
            document.getElementById('checkoutsContent').style.display = 'block';

            const tbody = document.getElementById('checkoutsTableBody');
            const tableWrapper = document.getElementById('checkoutsTableWrapper');
            const noCheckouts = document.getElementById('noCheckouts');

            if (checkouts.length === 0) {
                tableWrapper.style.display = 'none';
                noCheckouts.style.display = 'block';
                return;
            }

            tableWrapper.style.display = 'block';
            noCheckouts.style.display = 'none';

            // Build table rows
            const rows = checkouts.map(checkout => {
                const checkedOutAt = checkout.checked_out_at ? new Date(checkout.checked_out_at) : null;
                const formattedTime = checkedOutAt ? formatDateTime(checkedOutAt) : '-';
                const duration = checkedOutAt ? calculateDuration(checkedOutAt) : '-';

                return `
                    <tr>
                        <td>${escapeHtml(checkout.username || '-')}</td>
                        <td>${escapeHtml(checkout.host || '-')}</td>
                        <td>${formattedTime}</td>
                        <td>${duration}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        // Format date/time
        function formatDateTime(date) {
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // Calculate duration from checkout time to now
        function calculateDuration(checkoutTime) {
            const now = new Date();
            const diffMs = now - checkoutTime;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) {
                return `${diffDays}d ${diffHours % 24}h`;
            } else if (diffHours > 0) {
                return `${diffHours}h ${diffMinutes % 60}m`;
            } else if (diffMinutes > 0) {
                return `${diffMinutes}m`;
            } else {
                return `${diffSeconds}s`;
            }
        }
    </script>
</body>
</html>
