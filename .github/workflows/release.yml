name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux builds (on Ubuntu)
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            output_name: licet-linux-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            output_name: licet-linux-arm64
            cc: aarch64-linux-gnu-gcc
          - os: ubuntu-latest
            goos: linux
            goarch: arm
            goarm: 7
            output_name: licet-linux-armv7
            cc: arm-linux-gnueabihf-gcc

          # macOS builds (on macOS runners)
          - os: macos-latest
            goos: darwin
            goarch: amd64
            output_name: licet-darwin-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            output_name: licet-darwin-arm64

          # Windows build (on Ubuntu with MinGW)
          - os: ubuntu-latest
            goos: windows
            goarch: amd64
            output_name: licet-windows-amd64.exe
            cc: x86_64-w64-mingw32-gcc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag verification

      - name: Verify tag is on main branch
        run: |
          # Get the commit hash of the current tag
          TAG_COMMIT=$(git rev-parse HEAD)

          # Check if this commit exists in main branch history
          git fetch origin main
          if ! git merge-base --is-ancestor $TAG_COMMIT origin/main; then
            echo "❌ ERROR: Tag is not on main branch!"
            echo "Please merge your changes to main before creating a release tag."
            echo ""
            echo "Correct workflow:"
            echo "  1. Merge your branch to main"
            echo "  2. Checkout main: git checkout main && git pull"
            echo "  3. Create tag: git tag -a v1.0.0 -m 'Release'"
            echo "  4. Push tag: git push origin v1.0.0"
            exit 1
          fi
          echo "✅ Tag is on main branch - proceeding with release"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Get dependencies
        run: go mod download

      - name: Install cross-compilation tools (Ubuntu only)
        if: matrix.os == 'ubuntu-latest' && matrix.cc != ''
        run: |
          sudo apt-get update
          if [ "${{ matrix.goarch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          elif [ "${{ matrix.goarch }}" = "arm" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
          elif [ "${{ matrix.goos }}" = "windows" ]; then
            sudo apt-get install -y gcc-mingw-w64-x86-64
          fi

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          go build -ldflags="-s -w -X main.Version=${VERSION}" \
            -o build/${{ matrix.output_name }} \
            ./cmd/server

      - name: Create archive (Unix)
        if: matrix.goos != 'windows'
        run: |
          cd build
          tar -czf ${{ matrix.output_name }}.tar.gz ${{ matrix.output_name }}
          sha256sum ${{ matrix.output_name }}.tar.gz > ${{ matrix.output_name }}.tar.gz.sha256

      - name: Create archive (Windows)
        if: matrix.goos == 'windows'
        run: |
          cd build
          zip ${{ matrix.output_name }}.zip ${{ matrix.output_name }}
          sha256sum ${{ matrix.output_name }}.zip > ${{ matrix.output_name }}.zip.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.output_name }}
          path: |
            build/${{ matrix.output_name }}*
          retention-days: 1

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec cp {} release-assets/ \;
          ls -lh release-assets/

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release-notes.md
          ## Licet ${{ steps.get_version.outputs.VERSION }}

          ### Downloads

          Choose the appropriate binary for your platform:

          **Linux:**
          - `licet-linux-amd64.tar.gz` - 64-bit Intel/AMD (most common)
          - `licet-linux-arm64.tar.gz` - 64-bit ARM (Apple Silicon, Raspberry Pi 4+)
          - `licet-linux-armv7.tar.gz` - 32-bit ARM (Raspberry Pi 3)

          **macOS:**
          - `licet-darwin-amd64.tar.gz` - Intel Macs
          - `licet-darwin-arm64.tar.gz` - Apple Silicon (M1/M2/M3)

          **Windows:**
          - `licet-windows-amd64.exe.zip` - 64-bit Windows

          ### Installation

          **Linux/macOS:**
          ```bash
          # Download and extract (example for Linux AMD64)
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/licet-linux-amd64.tar.gz
          tar -xzf licet-linux-amd64.tar.gz
          chmod +x licet-linux-amd64
          ./licet-linux-amd64 --help
          ```

          **Windows:**
          ```powershell
          # Download the .zip file and extract it
          # Run licet-windows-amd64.exe
          ```

          ### Verification

          Verify the download with SHA256 checksums:
          ```bash
          sha256sum -c licet-linux-amd64.tar.gz.sha256
          ```

          ### Quick Start

          1. Copy the example configuration:
             ```bash
             cp config.example.yaml config.yaml
             ```

          2. Edit `config.yaml` with your license server details

          3. Run the server:
             ```bash
             ./licet-linux-amd64
             ```

          4. Access the web UI at http://localhost:8080

          ### What's Changed

          See the [commit history](https://github.com/${{ github.repository }}/commits/${{ steps.get_version.outputs.VERSION }}) for detailed changes.

          ### Documentation

          - [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/README.md)
          - [Configuration Guide](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/config.example.yaml)
          - [Implementation Details](https://github.com/${{ github.repository }}/blob/${{ steps.get_version.outputs.VERSION }}/GO_IMPLEMENTATION.md)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
